name: Rust Tests ðŸ‘¾
on: push

permissions:
  packages: write
  pages: write
  id-token: write
  contents: read
env:
  REGISTRY_URL: ghcr.io

jobs:
  build:
    runs-on: ubuntu-latest
    services:
      envio-postgres:
        image: postgres:17.5
        ports:
          - 5433:5432
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: envio
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      galileo-postgres:
        image: postgres:17.5
        ports:
          - 5432:5432
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: galileo
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      graphql-engine:
        image: hasura/graphql-engine:v2.43.0
        ports:
          - 8080:8080
        env:
          HASURA_GRAPHQL_DATABASE_URL: postgres://postgres:postgres@envio-postgres:5432/envio
          HASURA_GRAPHQL_ENABLE_CONSOLE: false
          HASURA_GRAPHQL_ENABLED_LOG_TYPES:
            startup, http-log, webhook-log, websocket-log,
            query-log
          HASURA_GRAPHQL_NO_OF_RETRIES: 10
          HASURA_GRAPHQL_ADMIN_SECRET: testing
          HASURA_GRAPHQL_STRINGIFY_NUMERIC_TYPES: "true"
          PORT: 8080
          HASURA_GRAPHQL_UNAUTHORIZED_ROLE: public
      envio-indexer:
        image: ghcr.io/anoma/galileo-indexer:main-envio-
        ports:
          - 9898:9898
        env:
          # ENVIO_API_TOKEN: ${HYPERSYNC_API_TOKEN}
          ENVIO_PG_PASSWORD: postgres
          ENVIO_PG_HOST: envio-postgres
          ENVIO_PG_PORT: 5432
          ENVIO_PG_USER: postgres
          ENVIO_PG_DATABASE: envio
          ENVIO_PG_PUBLIC_SCHEMA: envio
          ENVIO_INDEXER_HOST: 0.0.0.0
          ENVIO_INDEXER_PORT: 9898
          CONFIG_FILE: config.yaml
          LOG_LEVEL: trace
          LOG_STRATEGY: console-pretty
          HASURA_GRAPHQL_ENDPOINT: http://graphql-engine:8080/v1/metadata
          HASURA_GRAPHQL_ADMIN_SECRET: testing
          HASURA_SERVICE_HOST: graphql-engine
          HASURA_SERVICE_PORT: 8080
          TUI_OFF: true
      galileo-indexer:
        image: ghcr.io/anoma/galileo-indexer:main
        credentials:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
        ports:
          - 4000:4000
        env:
          ENVIO_ENDPOINT: http://graphql-engine:8080/v1/graphql
          DATABASE_URL: postgres://postgres:postgres@galileo-postgres:5432/galileo
          SECRET_KEY_BASE: nEaQ7PmzxnlBsMZyjrGo08tXnfZCffraBoVA0Ji2uKFvvZojUMFugmx2R4sGLjxV
          PHX_HOST: "localhost"
          PORT: 4000
          PHX_SERVER: true
    name: ${{ matrix.command.step }}
    env:
      CACHE_VERSION: v0
    strategy:
      fail-fast: false
      matrix:
        command:
          - step: Test
            name: Run tests
            cmd: just ci-test
            cache_key: ci-test
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: "recursive"
      - uses: rui314/setup-mold@v1
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy
          cache: false
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.command.cache_key }}-cargo-${{ hashFiles('**/Cargo.lock') }}-${{ env.CACHE_VERSION }}
      - name: Install just
        uses: extractions/setup-just@v3
      - name: Install foundry
        uses: foundry-rs/foundry-toolchain@v1
      - name: ${{ matrix.command.name }}
        run: ${{ matrix.command.cmd }}
        env:
          RPC_URL: ${{ secrets.RPC_URL }}
          GALILEO_INDEXER_ADDRESS: "http://localhost:4000"
          FEE_PAYMENT_WALLET_PRIVATE_KEY: ${{ secrets.FEE_PAYMENT_WALLET_PRIVATE_KEY }}
          ALCHEMY_API_KEY: ${{ secrets.ALCHEMY_API_KEY }}
          BONSAI_API_KEY: ${{ secrets.BONSAI_API_KEY }}
          BONSAI_API_URL: ${{ secrets.BONSAI_API_URL }}
